# WebAssembly エンジンアーキテクチャ

## 新しい設計

探索エンジン全体をWASMに移行しました。これにより、JavaScript↔WASM間の頻繁な通信を削減し、大幅な性能向上を実現します。

### アーキテクチャ概要

```
JavaScript (Worker)              WASM (Rust)
──────────────────              ─────────────
初期化・UI更新                   PathfinderEngine
├─ WASM初期化                   ├─ BinaryHeap (優先度付きキュー)
├─ 進捗表示                     ├─ HashSet (訪問済み管理)
└─ キャンセル処理               ├─ HashMap (キャッシュ)
                                ├─ ヒント適用ロジック
                                ├─ レーベンシュタイン距離計算
                                └─ 探索アルゴリズム全体
```

### 主な改善点

#### 1. **探索ロジックの完全なWASM実装**
- 優先度付きキュー、訪問済み管理、ヒント適用をすべてRustで実装
- JavaScript↔WASM間の通信を最小限に削減

#### 2. **バッチ処理アプローチ**
- `run_iterations(100)` で100回分の探索をまとめて実行
- 結果は構造化されたオブジェクトで返却
- 進捗更新は100ミリ秒ごとに制限

#### 3. **効率的なデータ構造**
- Rust の `BinaryHeap` で O(log n) の優先度付きキュー操作
- `HashMap` によるキャッシング（距離計算、デコード結果）
- `HashSet` による訪問済み状態の高速チェック

#### 4. **メモリ効率**
- 文字列のコピーを最小限に
- キャッシュサイズの自動管理（10,000エントリで自動クリア）

### パフォーマンス向上

以前の実装と比較して：

1. **JSONシリアライゼーションの削除**: 最大のボトルネック解消
2. **WASM境界越えの削減**: 数千回→数十回に削減
3. **ネイティブデータ構造**: Rustの高速なコレクション型を活用
4. **バッチ処理**: オーバーヘッドの分散

期待される性能向上：**10-50倍**

### 使用方法

```typescript
// Worker内で
const engine = new PathfinderEngine(start, target, hintsJson, maxDepth);

while (!engine.is_complete()) {
    const result = engine.run_iterations(100);
    
    if (result.found) {
        // 経路発見
        return result;
    }
    
    // 進捗更新
    postMessage({ type: 'progress', ...result });
}
```

### 今後の最適化可能性

1. **SIMD命令の活用**: レーベンシュタイン距離計算のさらなる高速化
2. **並列処理**: 複数の状態を同時に評価
3. **メモリプール**: アロケーションの削減
4. **ヒント前処理**: より効率的なフィルタリング